---
title: "calibrate"
author: "Xiaoliang Zhou"
date: '2022-11-25'
output: html_document
---

# Install software (Refer to 'explore data.Rmd' in 'rCode' foler)

```{r}
library(RaschKit)
install_packages_ls()
create_folders() 
```

Open this .Rmd file via 'xxx.Rproj' in working directory.
Select function below for different cases. Functions would output instructions 
on where to find report and/or result files.

# Check data and codebook

## Data

Read data to be used for 'data' argument of Function calibrate.
Note that data should have covariates followed by responses.

```{r}
resp <- readxl::read_xlsx(list.files(here::here('dataRaw'), 'data', # revised to file name
         full.names = TRUE)) %>% 
    map_df(~toupper(.x))
```

Check whether columns have responses other than valid ones like A,B,C,D....
If there is invalid one, put that into 'missCode2Conv' argument of Function 
calibrate to recode them. If default of 'missCode2Conv' includes non-response 
symbol found in items, can ignore missCode2Conv below.

```{r}
lapply(resp[-1], table)
```

## Codebook

```{r}
cd <- readxl::read_xlsx(list.files(here::here('dataRaw'), 'codebook', # revised to file name
         full.names = TRUE)) %>% 
    row_to_names(1) 
keys <- cd %>% 
    pull(Key) # Used as 'keys' for'calibrate' (below)
labels <- cd %>% 
    pull(Item) # Used as 'labels' for'calibrate' (below)
```

## Update key after review

This may occur when you send 1st round of item analysis results to test developers
and they advise psychometricians to change key, use double key, or remove items.

```{r}
keys[25] <- 'A' 
keys[53] <- 'B'
keys[67] <- 'C'
```

# Explore function

```{r}
calibrate(test='FPA', data=resp, pid='pid', n_cov=1, keys=keys, labels=labels)
```

Below are useful arguments in 'calibrate'. 

## Must set 

test: Test name, e.g., 'GAT'; any meaningful name; 'xxx' below.
pid: Candidate ID variable name in data.
n_cov: Number of covariates before responses.

## May ignore

data: Ignore if 'xxx.sav' (or xxx.xlsx) is in 'data' folder.
keys: Ignore if correct answers all coded as 1 in data.
labels: Ignore if column names are same as labels.

## Set if test developer advises so after review

delete: int Vector of item order, or char vector of item labels.
dbl_key: list(`5`=c(1,3), `29`=c(3,4)).

## Regressor

regr_vec_char: categorical vector of regressor names in data.

## Multi-dimensional modeling

n_dims: integer Vector of dimensions' item numbers in test.
dim_names: dimension names (e.g., c('Literacy', 'Numeracy')); any meaningful name.

## Polytomous items

Prepare key file (Refer to sample Sheet 'test' in keys.xlsx).
- In keys.xlsx in 'data' folder, add a sheet with name same as 'test' 
  argument of 'calibrate'.  
- On the sheet, add columns below (row order same as response order in data).
  - Item: item labels; same as 'labels' argument of 'calibrate'.
  - Key: key for MC items; maximum score for polytomous items.
  - Max_score: maximum score for each item.
  - Key2: 2nd key; remove if no double key.

- Set poly_key = TRUE in 'calibrate'.

## Extra lines in CQ control file

section_extr: Vector of strings as CQ command, if needed to add to control file.

## Item flagging criteria

Can change values to satisfy project requirements.

easy, hard, iRst, fit_w, fit_u: For flagging items.
dFallThr, dRiseThr: For comments on CCC's.

## Explore more

Run '?calibrate' to know more details of arguments mentioned and more arguments.